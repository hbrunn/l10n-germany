# Copyright 2022 Hunki Enterprises BV
# License AGPL-3.0 or later (https://www.gnu.org/licenses/agpl).
from odoo import models


class AccountChartTemplate(models.Model):
    _inherit = "account.chart.template"

    def _load(self, sale_tax_rate, purchase_tax_rate, company):
        result = super()._load(sale_tax_rate, purchase_tax_rate, company)
        self._datev_set_nonautomatic_flag(company)
        return result

    def _datev_set_nonautomatic_flag(self, company):
        """Set nonautomatic flag for accounts of known COAs"""
        coa2accounts = {
            # xmlid_of_chart_template: (iterable, of, account, codes)
            "l10n_de_skr03.l10n_de_chart_template": (
                "1711",
                "1718",
                "2401",
                "2402",
                "2403",
                "2406",
                "2408",
                "2431",
                "2436",
                "2751",
                "2752",
                "3010",
                "3030",
                "3060",
                "3062",
                "3066",
                "3067",
                "3070",
                "3071",
                "3075",
                "3076",
                "3089",
                "3091",
                "3092",
                "3106",
                "3108",
                "3110",
                "3113",
                "3115",
                "3120",
                "3123",
                "3125",
                "3130",
                "3133",
                "3135",
                "3140",
                "3143",
                "3145",
                "3150",
                "3151",
                "3153",
                "3154",
                "3300",
                "3349",
                "3400",
                "3420",
                "3425",
                "3435",
                "3440",
                "3505",
                "3540",
                "3550",
                "3553",
                "3560",
                "3565",
                "3610",
                "3660",
                "3710",
                "3714",
                "3715",
                "3717",
                "3718",
                "3720",
                "3724",
                "3725",
                "3731",
                "3734",
                "3736",
                "3738",
                "3741",
                "3743",
                "3744",
                "3745",
                "3746",
                "3748",
                "3750",
                "3754",
                "3755",
                "3760",
                "3780",
                "3784",
                "3785",
                "3788",
                "3790",
                "3792",
                "3793",
                "3794",
                "3796",
                "3798",
                "8100",
                "8105",
                "8110",
                "8120",
                "8125",
                "8130",
                "8135",
                "8140",
                "8150",
                "8160",
                "8165",
                "8191",
                "8194",
                "8196",
                "8300",
                "8310",
                "8315",
                "8320",
                "8335",
                "8336",
                "8337",
                "8338",
                "8339",
                "8400",
                "8410",
                "8514",
                "8515",
                "8516",
                "8519",
                "8574",
                "8575",
                "8576",
                "8579",
                "8591",
                "8595",
                "8609",
                "8611",
                "8613",
                "8625",
                "8630",
                "8640",
                "8701",
                "8702",
                "8703",
                "8704",
                "8705",
                "8710",
                "8720",
                "8724",
                "8725",
                "8726",
                "8731",
                "8736",
                "8738",
                "8741",
                "8742",
                "8743",
                "8745",
                "8746",
                "8748",
                "8750",
                "8760",
                "8780",
                "8790",
                "8801",
                "8807",
                "8808",
                "8820",
                "8827",
                "8828",
                "8850",
                "8851",
                "8852",
                "8910",
                "8915",
                "8920",
                "8921",
                "8922",
                "8925",
                "8930",
                "8932",
                "8935",
                "8940",
                "8945",
            ),
        }

        for xmlid, accounts in coa2accounts.items():
            if self == self.env.ref(xmlid, raise_if_not_found=False):
                self.env["account.account"].search(
                    [
                        ("code", "in", accounts),
                        ("company_id", "=", company.id),
                    ]
                ).write({"datev_export_nonautomatic": True})
